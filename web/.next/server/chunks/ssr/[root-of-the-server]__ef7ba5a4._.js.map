{"version":3,"sources":["../../../../src/app/page.tsx","../../../../src/lib/serverCache.ts"],"sourcesContent":["import HomePageClient from '@/components/HomePageClient';\r\nimport { getPublicationsWithServerCache } from '@/lib/serverCache';\r\n\r\n// 캐시 설정: 매 요청마다 최신 버전 체크 (시간 제한 없음)\r\nexport const dynamic = 'force-dynamic';\r\nexport const revalidate = 0;\r\n\r\nexport default async function Home() {\r\n  // 서버 공유 캐시 사용: 변경 있을 때만 Firestore 조회\r\n  const { issues, articles } = await getPublicationsWithServerCache();\r\n\r\n  return <HomePageClient articles={articles} issues={issues} />;\r\n}\r\n\r\n","/**\r\n * 서버 사이드 공유 캐시\r\n * - 모든 사용자가 같은 캐시 공유\r\n * - 접속 시 최신 버전 확인 후 조건부 갱신\r\n * - [Refactor] 2025-12: Backend API 의존성 제거 -> Firestore 직접 조회\r\n */\r\n\r\nimport { optimizeArticleOrder } from '@/utils/layoutOptimizer';\r\nimport {\r\n    fetchPublishedIssues,\r\n    fetchArticlesByIssueId,\r\n    checkLatestUpdate,\r\n    Issue,\r\n    Article\r\n} from './firestoreService';\r\n\r\ninterface ServerCache {\r\n    issues: Issue[];\r\n    articles: Article[];\r\n    lastUpdatedAt: string | null;\r\n}\r\n\r\n// 서버 메모리 공유 캐시 (모든 요청이 공유)\r\nlet serverCache: ServerCache | null = null;\r\n\r\n/**\r\n * 백엔드(DB)에서 최신 버전 확인\r\n */\r\nasync function checkForUpdates(): Promise<{ changed: boolean; latestUpdatedAt: string | null }> {\r\n    try {\r\n        const currentVersion = serverCache?.lastUpdatedAt;\r\n        const latestVersion = await checkLatestUpdate();\r\n\r\n        // DB에 데이터가 없거나 에러면 변경 없는 것으로 처리 (안전장치)\r\n        if (!latestVersion) {\r\n            return { changed: false, latestUpdatedAt: currentVersion || null };\r\n        }\r\n\r\n        const changed = currentVersion !== latestVersion;\r\n\r\n        if (changed) {\r\n            console.log(`[ServerCache] Detect Change: ${currentVersion} -> ${latestVersion}`);\r\n        } else {\r\n            console.log(`[ServerCache] No Change (Latest: ${latestVersion})`);\r\n        }\r\n\r\n        return { changed, latestUpdatedAt: latestVersion };\r\n\r\n    } catch (error) {\r\n        console.error('[ServerCache] Check error:', error);\r\n        return { changed: true, latestUpdatedAt: null };\r\n    }\r\n}\r\n\r\n/**\r\n * 전체 데이터 가져오기 (Firestore 직접 조회)\r\n */\r\nasync function fetchAllData(): Promise<{ issues: Issue[]; articles: Article[]; latestUpdatedAt: string | null }> {\r\n    console.log('[ServerCache] Fetching fresh data from Firestore (Direct)...');\r\n\r\n    try {\r\n        // 1. 회차 목록 조회\r\n        const { issues, latestUpdatedAt } = await fetchPublishedIssues();\r\n\r\n        if (issues.length === 0) {\r\n            console.warn('[ServerCache] No issues found.');\r\n            return { issues: [], articles: [], latestUpdatedAt: null };\r\n        }\r\n\r\n        // 2. 각 회차의 기사 조회 (병렬)\r\n        const articlePromises = issues.map(async (issue) => {\r\n            try {\r\n                const articles = await fetchArticlesByIssueId(issue.id);\r\n                // Layout Optimizer 적용 및 메타데이터 주입\r\n                return optimizeArticleOrder(articles).map((article: Article) => ({\r\n                    ...article,\r\n                    publish_id: issue.id,\r\n                    edition_name: issue.edition_name,\r\n                    edition_code: issue.edition_code,\r\n                }));\r\n            } catch (err) {\r\n                console.error(`[ServerCache] Failed to fetch articles for issue ${issue.id}`, err);\r\n                return [];\r\n            }\r\n        });\r\n\r\n        const articlesArrays = await Promise.all(articlePromises);\r\n        const allArticles = articlesArrays.flat();\r\n\r\n        console.log(`[ServerCache] Fetched ${issues.length} issues, ${allArticles.length} articles`);\r\n\r\n        return { issues, articles: allArticles, latestUpdatedAt };\r\n    } catch (error) {\r\n        console.error('[ServerCache] Fetch error:', error);\r\n        return { issues: [], articles: [], latestUpdatedAt: null };\r\n    }\r\n}\r\n\r\n/**\r\n * 캐시된 데이터 가져오기 (메인 함수)\r\n */\r\nexport async function getPublicationsWithServerCache(): Promise<{ issues: Issue[]; articles: Article[] }> {\r\n    // 캐시가 없으면 전체 fetch\r\n    if (!serverCache) {\r\n        const data = await fetchAllData();\r\n        serverCache = {\r\n            issues: data.issues,\r\n            articles: data.articles,\r\n            lastUpdatedAt: data.latestUpdatedAt\r\n        };\r\n        return { issues: data.issues, articles: data.articles };\r\n    }\r\n\r\n    // 캐시가 있으면 변경 체크\r\n    const { changed, latestUpdatedAt } = await checkForUpdates();\r\n\r\n    if (!changed) {\r\n        // console.log('[ServerCache] Using cached data ✅');\r\n        return { issues: serverCache.issues, articles: serverCache.articles };\r\n    }\r\n\r\n    // 변경 있으면 전체 갱신\r\n    console.log('[ServerCache] Data changed, refreshing...');\r\n    const data = await fetchAllData();\r\n    serverCache = {\r\n        issues: data.issues,\r\n        articles: data.articles,\r\n        lastUpdatedAt: data.latestUpdatedAt || latestUpdatedAt\r\n    };\r\n\r\n    return { issues: data.issues, articles: data.articles };\r\n}\r\n\r\n/**\r\n * 캐시 무효화 (수동)\r\n */\r\nexport function invalidateServerCache(): void {\r\n    serverCache = null;\r\n    console.log('[ServerCache] Invalidated');\r\n}\r\n"],"names":[],"mappings":"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"}