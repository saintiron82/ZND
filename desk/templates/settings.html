<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZND Desk - ì„¤ì •</title>
    <link rel="stylesheet" href="/static/css/desk.css">
</head>

<body class="env-{{ znd_env }}">
    <!-- Navigation -->
    <nav class="nav-tabs">
        <a href="/analyzer" class="tab">ğŸ”¬ AI ë¶„ì„</a>
        <a href="/publisher" class="tab">ğŸ“¢ ë°œí–‰</a>
        <a href="/board" class="tab">ğŸ“‹ ë³´ë“œ</a>
        <div class="nav-right">
            <a href="/settings" class="btn-settings active">âš™ï¸ ì„¤ì •</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <h1>ì„¤ì •</h1>

        <!-- Schedule Section -->
        <section class="settings-section">
            <div class="section-header">
                <h2>ğŸ“… ìˆ˜ì§‘ ìŠ¤ì¼€ì¤„ë§</h2>
                <button id="btn-add-schedule" class="btn btn-primary">+ ìŠ¤ì¼€ì¤„ ì¶”ê°€</button>
            </div>

            <div class="schedule-list" id="schedule-list">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
            </div>
        </section>

        <!-- Firebase Usage Section -->
        <section class="settings-section">
            <div class="section-header">
                <h2>ğŸ”¥ Firebase ì‚¬ìš©ëŸ‰</h2>
                <button id="btn-reset-stats" class="btn">ë¦¬ì…‹</button>
            </div>

            <div class="stats-grid" id="firebase-stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-reads">-</div>
                    <div class="stat-label">ì½ê¸°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-writes">-</div>
                    <div class="stat-label">ì“°ê¸°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-deletes">-</div>
                    <div class="stat-label">ì‚­ì œ</div>
                </div>
            </div>
        </section>

        <!-- Add Schedule Modal -->
        <div id="schedule-modal" class="modal hidden">
            <div class="modal-content">
                <h3 id="modal-title">ìŠ¤ì¼€ì¤„ ì¶”ê°€</h3>
                <input type="hidden" id="edit-schedule-id">
                <input type="hidden" id="edit-schedule-cron">
                <div class="form-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="schedule-name" class="input" placeholder="ìŠ¤ì¼€ì¤„ ì´ë¦„">
                </div>
                <div class="form-group">
                    <label>ì‹¤í–‰ ì‹œê°„ (KST)</label>
                    <div class="time-picker">
                        <select id="schedule-hour" class="input time-select">
                            <!-- 0-23 ì‹œê°„ ì˜µì…˜ -->
                        </select>
                        <span class="time-separator">:</span>
                        <select id="schedule-minute" class="input time-select">
                            <!-- 0-59 ë¶„ ì˜µì…˜ -->
                        </select>
                        <span class="time-label">KST</span>
                    </div>
                    <small class="hint">í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì…ë ¥í•˜ë©´ UTCë¡œ ìë™ ë³€í™˜ë©ë‹ˆë‹¤.</small>
                </div>
                <div class="form-group">
                    <label class="toggle-label">
                        <span class="toggle">
                            <input type="checkbox" id="schedule-discord">
                            <span class="slider"></span>
                        </span>
                        <span>ë””ìŠ¤ì½”ë“œ ì•Œë¦¼</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button id="btn-modal-save" class="btn btn-primary">ì €ì¥</button>
                    <button id="btn-modal-cancel" class="btn">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </main>

    <script src="/static/js/constants.js"></script>
    <script src="/static/js/desk-common.js?v=20241229"></script>
    <script src="/static/js/desk.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initSettingsPage();
        });

        async function initSettingsPage() {
            await loadSchedules();
            await loadFirebaseStats();
            setupSettingsEvents();
        }

        async function loadSchedules() {
            try {
                const result = await fetchAPI('/api/settings/schedules');
                if (result.success) {
                    renderSchedules(result.schedules);
                }
            } catch (e) {
                console.error('Failed to load schedules:', e);
            }
        }

        // KST <-> UTC ë³€í™˜ í•¨ìˆ˜
        function kstToUtcCron(hour, minute) {
            let utcHour = hour - 9;
            if (utcHour < 0) utcHour += 24;
            return `${minute} ${utcHour} * * *`;
        }

        function utcCronToKst(cron) {
            const parts = cron.split(' ');
            if (parts.length < 2) return { hour: 0, minute: 0, display: '00:00' };
            const minute = parseInt(parts[0]) || 0;
            const utcHour = parseInt(parts[1]) || 0;
            let kstHour = (utcHour + 9) % 24;
            return {
                hour: kstHour,
                minute: minute,
                display: `${String(kstHour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`
            };
        }

        function renderSchedules(schedules) {
            const container = document.getElementById('schedule-list');
            if (!container) return;

            container.innerHTML = schedules.map(s => {
                const kst = utcCronToKst(s.cron);
                const discordIcon = s.discord ? 'ğŸ””' : 'ğŸ”•';
                return `
                <div class="schedule-item" data-id="${s.id}" data-cron="${s.cron}" data-discord="${s.discord || false}">
                    <div class="schedule-info">
                        <label class="toggle">
                            <input type="checkbox" class="schedule-toggle" ${s.enabled ? 'checked' : ''}>
                            <span class="slider"></span>
                        </label>
                        <span class="schedule-name">${s.name}</span>
                        <span class="schedule-time">${kst.display} KST</span>
                        <span class="schedule-discord" title="ë””ìŠ¤ì½”ë“œ ì•Œë¦¼">${discordIcon}</span>
                    </div>
                    <div class="schedule-actions">
                        <button class="btn btn-edit" onclick="editSchedule('${s.id}')">âœï¸</button>
                        <button class="btn btn-danger btn-delete" onclick="deleteSchedule('${s.id}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `}).join('');

            // Toggle events
            container.querySelectorAll('.schedule-toggle').forEach(toggle => {
                toggle.addEventListener('change', async (e) => {
                    const item = e.target.closest('.schedule-item');
                    const id = item.dataset.id;
                    await fetchAPI(`/api/settings/schedules/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ enabled: e.target.checked })
                    });
                });
            });
        }

        async function loadFirebaseStats() {
            try {
                const result = await fetchAPI('/api/settings/firebase-stats');
                if (result.success) {
                    document.getElementById('stat-reads').textContent = result.stats.reads;
                    document.getElementById('stat-writes').textContent = result.stats.writes;
                    document.getElementById('stat-deletes').textContent = result.stats.deletes;
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        function initTimeSelectors() {
            const hourSelect = document.getElementById('schedule-hour');
            const minuteSelect = document.getElementById('schedule-minute');

            // ì‹œê°„ ì˜µì…˜ (0-23)
            hourSelect.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                hourSelect.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
            }

            // ë¶„ ì˜µì…˜ (0-59)
            minuteSelect.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                minuteSelect.innerHTML += `<option value="${i}">${String(i).padStart(2, '0')}</option>`;
            }
        }

        function setupSettingsEvents() {
            // ì‹œê°„ ì„ íƒê¸° ì´ˆê¸°í™”
            initTimeSelectors();

            // Add schedule
            document.getElementById('btn-add-schedule')?.addEventListener('click', () => {
                document.getElementById('modal-title').textContent = 'ìŠ¤ì¼€ì¤„ ì¶”ê°€';
                document.getElementById('edit-schedule-id').value = '';
                document.getElementById('edit-schedule-cron').value = '';
                document.getElementById('schedule-name').value = '';
                document.getElementById('schedule-hour').value = '6';
                document.getElementById('schedule-minute').value = '30';
                document.getElementById('schedule-discord').checked = false;
                document.getElementById('schedule-modal').classList.remove('hidden');
            });

            // Modal save
            document.getElementById('btn-modal-save')?.addEventListener('click', async () => {
                const id = document.getElementById('edit-schedule-id').value;
                const name = document.getElementById('schedule-name').value;
                const hour = parseInt(document.getElementById('schedule-hour').value);
                const minute = parseInt(document.getElementById('schedule-minute').value);
                const discord = document.getElementById('schedule-discord').checked;

                // KST -> UTC ë³€í™˜
                const cron = kstToUtcCron(hour, minute);

                if (!name) {
                    alert('ìŠ¤ì¼€ì¤„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                showLoading();
                try {
                    if (id) {
                        await fetchAPI(`/api/settings/schedules/${id}`, {
                            method: 'PUT',
                            body: JSON.stringify({ name, cron, discord })
                        });
                    } else {
                        await fetchAPI('/api/settings/schedules', {
                            method: 'POST',
                            body: JSON.stringify({ name, cron, discord })
                        });
                    }
                    document.getElementById('schedule-modal').classList.add('hidden');
                    await loadSchedules();
                } finally {
                    hideLoading();
                }
            });

            // Modal cancel
            document.getElementById('btn-modal-cancel')?.addEventListener('click', () => {
                document.getElementById('schedule-modal').classList.add('hidden');
            });

            // Reset stats
            document.getElementById('btn-reset-stats')?.addEventListener('click', async () => {
                await fetchAPI('/api/settings/firebase-stats/reset', { method: 'POST' });
                await loadFirebaseStats();
            });
        }

        function editSchedule(id) {
            const item = document.querySelector(`.schedule-item[data-id="${id}"]`);
            const name = item.querySelector('.schedule-name').textContent;
            const cron = item.dataset.cron;
            const discord = item.dataset.discord === 'true';
            const kst = utcCronToKst(cron);

            document.getElementById('modal-title').textContent = 'ìŠ¤ì¼€ì¤„ ìˆ˜ì •';
            document.getElementById('edit-schedule-id').value = id;
            document.getElementById('edit-schedule-cron').value = cron;
            document.getElementById('schedule-name').value = name;
            document.getElementById('schedule-hour').value = kst.hour;
            document.getElementById('schedule-minute').value = kst.minute;
            document.getElementById('schedule-discord').checked = discord;
            document.getElementById('schedule-modal').classList.remove('hidden');
        }

        async function deleteSchedule(id) {
            if (!confirm('ì´ ìŠ¤ì¼€ì¤„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();
            try {
                await fetchAPI(`/api/settings/schedules/${id}`, { method: 'DELETE' });
                await loadSchedules();
            } finally {
                hideLoading();
            }
        }
    </script>

    <style>
        .settings-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-header h2 {
            font-size: 1.2rem;
            margin: 0;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .schedule-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .schedule-time {
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .schedule-discord {
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }

        .schedule-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Time Picker */
        .time-picker {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .time-select {
            width: 80px !important;
            text-align: center;
        }

        .time-separator {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .time-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Toggle Label */
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-success);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group .input {
            width: 100%;
        }

        .hint {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: block;
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
    </style>
</body>

</html>