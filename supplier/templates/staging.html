<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staging Preview - ë§ˆìŠ¤í„° ì „ìš©</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            min-height: 100vh;
            color: #eee;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .filter-group label {
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-refresh {
            background: #4ecdc4;
            color: white;
        }

        .btn-publish {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card .label {
            font-size: 0.9em;
            color: #aaa;
        }

        .stat-staged .value {
            color: #4ecdc4;
        }

        .stat-rejected .value {
            color: #dc3545;
        }

        .stat-published .value {
            color: #28a745;
        }

        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .article-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #4ecdc4;
            transition: all 0.3s;
            cursor: pointer;
        }

        .article-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .article-card.rejected {
            border-left-color: #dc3545;
            opacity: 0.6;
        }

        .article-card.published {
            border-left-color: #28a745;
        }

        /* ì¹´í…Œê³ ë¦¬ë³„ í…Œë‘ë¦¬ ìƒ‰ìƒ */
        .article-card.cat-ai-ml {
            border-left-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(255, 255, 255, 0.05));
        }

        .article-card.cat-engineering {
            border-left-color: #f5576c;
            background: linear-gradient(135deg, rgba(245, 87, 108, 0.1), rgba(255, 255, 255, 0.05));
        }

        .article-card.cat-community {
            border-left-color: #4facfe;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(255, 255, 255, 0.05));
        }

        .article-card.cat-business {
            border-left-color: #43e97b;
            background: linear-gradient(135deg, rgba(67, 233, 123, 0.1), rgba(255, 255, 255, 0.05));
        }

        .article-card.cat-uncategorized {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 255, 255, 0.05));
        }

        /* ì»¤íŠ¸ë¼ì¸ ëŒ€ìƒ ì ë©¸ íš¨ê³¼ */
        @keyframes cutlineBlink {

            0%,
            100% {
                box-shadow: 0 0 0 2px rgba(245, 87, 108, 0.3);
                background: rgba(245, 87, 108, 0.1);
            }

            50% {
                box-shadow: 0 0 15px 3px rgba(245, 87, 108, 0.6);
                background: rgba(245, 87, 108, 0.25);
            }
        }

        .article-card.cutline-target {
            animation: cutlineBlink 1s ease-in-out infinite;
            border-left-color: #f5576c !important;
        }

        .score-badge.cutline-target {
            animation: cutlineBlink 0.8s ease-in-out infinite;
            background: #f5576c !important;
            color: white !important;
        }

        .article-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }

        .article-summary {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .article-meta {
            display: flex;
            gap: 10px;
            font-size: 0.8em;
            color: #888;
        }

        .score-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .score-zs {
            background: #ffc107;
            color: #333;
        }

        .score-is {
            background: #4ecdc4;
            color: white;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: auto;
        }

        .status-staged {
            background: #4ecdc4;
            color: white;
        }

        .status-rejected {
            background: #dc3545;
            color: white;
        }

        .status-published {
            background: #28a745;
            color: white;
        }

        .status-duplicate {
            background: #6c757d;
            color: white;
        }

        /* ì¹´í…Œê³ ë¦¬ ë°°ì§€ */
        .category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-right: 5px;
        }

        .cat-ai-ml {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .cat-engineering {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .cat-community {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: #333;
        }

        .cat-business {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: #333;
        }

        .cat-default {
            background: #6c757d;
            color: white;
        }

        /* ì¤‘ë³µ ê¸°ì‚¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .article-card.duplicate {
            border-left-color: #6c757d;
            opacity: 0.5;
            background: rgba(108, 117, 125, 0.1);
        }

        .article-card.duplicate::after {
            content: 'ì¤‘ë³µ';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .article-card {
            position: relative;
        }

        /* ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ í—¤ë” */
        .category-group-header {
            width: 100%;
            margin-top: 15px;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading,
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #888;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1e1e2e;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            background: #2a2a3e;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1em;
        }

        .modal-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .json-view {
            background: #0d0d14;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-break: break-all;
            color: #4ec9b0;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Schema Badge Colors */
        .schema-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
            margin-right: 5px;
            color: #fff;
        }

        .schema-v1 {
            background: #6f42c1;
        }

        .schema-v09 {
            background: #fd7e14;
        }

        .schema-hybrid {
            background: #20c997;
        }

        .schema-legacy {
            background: #6c757d;
        }

        .schema-unknown {
            background: #343a40;
        }

        /* ë¶„ë¥˜ í•˜ê¸°ìš© JSON ëª¨ë‹¬ */
        .dedup-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .dedup-modal-overlay.active {
            display: flex;
        }

        .dedup-modal-content {
            background: #1e1e2e;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 2px solid #ffc107;
        }

        .dedup-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #ffc107;
            background: linear-gradient(135deg, #2a2a3e, #3a3a4e);
        }

        .dedup-modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: #ffc107;
        }

        .dedup-modal-header .subtitle {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 3px;
        }

        .dedup-modal-actions {
            display: flex;
            gap: 8px;
        }

        .btn-copy {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 10px 20px;
            font-size: 1em;
        }

        .btn-copy:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
        }

        .btn-copy.copied {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .dedup-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .dedup-json-view {
            background: #0d0d14;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-break: break-all;
            color: #ffc107;
            max-height: 55vh;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .dedup-info {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #ccc;
        }

        .dedup-info strong {
            color: #ffc107;
        }

        /* ë¶™ì—¬ë„£ê¸° ì…ë ¥ ì˜ì—­ */
        .paste-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #444;
        }

        .paste-section h4 {
            margin: 0 0 10px 0;
            color: #4ecdc4;
            font-size: 0.95em;
        }

        .paste-textarea {
            width: 100%;
            height: 120px;
            background: #0d0d14;
            border: 1px solid #4ecdc4;
            border-radius: 8px;
            color: #4ecdc4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            padding: 10px;
            resize: vertical;
        }

        .paste-textarea::placeholder {
            color: #666;
        }

        .btn-apply {
            background: linear-gradient(135deg, #4ecdc4, #45b7aa);
            color: white;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div style="display:flex; flex-direction:column; gap:5px;">
            <h1>ğŸ“‹ Staging Preview <span style="font-size: 0.6em; color: #888;">(ë§ˆìŠ¤í„° ì „ìš©)</span></h1>
            <div style="font-size:0.8em; color:#aaa;">í—ˆìš©ëœ ë²„ì „ë§Œ í‘œì‹œë˜ë©°, í‘œì‹œëœ í•­ëª©ë§Œ ë°œí–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>

        <div class="header-controls">
            <!-- Schema Filter -->
            <div class="filter-group">
                <span style="font-size:0.8em; color:#ccc; font-weight:bold;">ğŸ‘ï¸ í‘œì‹œ í•„í„°:</span>
                <label><input type="checkbox" id="filter-v1" checked onchange="renderArticles()"> <span
                        class="schema-badge schema-v1">V1.0</span></label>
                <label><input type="checkbox" id="filter-hybrid" checked onchange="renderArticles()"> <span
                        class="schema-badge schema-hybrid">V0.9 (Hybrid)</span></label>
                <label><input type="checkbox" id="filter-v09" checked onchange="renderArticles()"> <span
                        class="schema-badge schema-v09">V0.9 (Std)</span></label>
                <label><input type="checkbox" id="filter-legacy" onchange="renderArticles()"> <span
                        class="schema-badge schema-legacy">Legacy</span></label>
            </div>

            <!-- Timezone Toggle -->
            <div class="filter-group">
                <span style="font-size:0.8em; color:#ccc; font-weight:bold;">ğŸ•’ ì‹œê°„:</span>
                <label><input type="radio" name="tz" value="local" checked onchange="toggleTimezone('local')">
                    Local</label>
                <label><input type="radio" name="tz" value="gmt" onchange="toggleTimezone('gmt')"> GMT</label>
            </div>

            <div class="header-actions">
                <button class="btn" style="background: #dc3545; color: white;" onclick="deleteLegacyCalls()">ğŸ—‘ï¸ LEGACY
                    ì‚­ì œ</button>
                <button class="btn btn-refresh" onclick="loadStaging()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
        </div>
    </div>

    <!-- 2ì—´ ë ˆì´ì•„ì›ƒ: ì‚¬ì´ë“œ íŒ¨ë„ + ê¸°ì‚¬ ê·¸ë¦¬ë“œ -->
    <div style="display: flex; gap: 20px; padding: 0 20px;">
        <!-- ì™¼ìª½: ì§„í–‰ ìƒí™© ì‚¬ì´ë“œ íŒ¨ë„ (ê³ ì •) -->
        <div id="sidePanel"
            style="width: 280px; flex-shrink: 0; position: sticky; top: 20px; align-self: flex-start; max-height: calc(100vh - 40px); overflow-y: auto;">
            <!-- ì „ì²´ í†µê³„ -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #4ecdc4;">ğŸ“Š ì „ì²´ í˜„í™©</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div
                        style="text-align: center; padding: 10px; background: rgba(78,205,196,0.2); border-radius: 8px;">
                        <div id="stagedCount" style="font-size: 1.5em; font-weight: bold; color: #4ecdc4;">-</div>
                        <div style="font-size: 0.75em; color: #aaa;">ëŒ€ê¸°ì¤‘</div>
                    </div>
                    <div
                        style="text-align: center; padding: 10px; background: rgba(220,53,69,0.2); border-radius: 8px;">
                        <div id="rejectedCount" style="font-size: 1.5em; font-weight: bold; color: #dc3545;">-</div>
                        <div style="font-size: 0.75em; color: #aaa;">ê±°ë¶€</div>
                    </div>
                    <div
                        style="text-align: center; padding: 10px; background: rgba(40,167,69,0.2); border-radius: 8px;">
                        <div id="publishedCount" style="font-size: 1.5em; font-weight: bold; color: #28a745;">-</div>
                        <div style="font-size: 0.75em; color: #aaa;">ë°œí–‰</div>
                    </div>
                </div>
            </div>

            <!-- ì»¤íŠ¸ë¼ì¸ ì„¤ì • -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #f5576c;">âœ‚ï¸ ì»¤íŠ¸ë¼ì¸</h4>

                <div style="margin-bottom: 12px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 0.85em; color: #ccc;">IS ìµœì†Œê°’</span>
                        <span id="cutlineISValue"
                            style="font-size: 0.9em; font-weight: bold; color: #4ecdc4;">3.0</span>
                    </div>
                    <input type="range" id="cutlineIS" min="0" max="10" step="0.1" value="3.0"
                        style="width: 100%; accent-color: #4ecdc4;" oninput="updateCutline()">
                    <div style="font-size: 0.7em; color: #888;">IS &lt; ì´ ê°’ â†’ ì»¤íŠ¸ë¼ì¸ ëŒ€ìƒ</div>
                </div>

                <div style="margin-bottom: 12px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 0.85em; color: #ccc;">ZS ìµœëŒ€ê°’</span>
                        <span id="cutlineZSValue"
                            style="font-size: 0.9em; font-weight: bold; color: #ffc107;">7.0</span>
                    </div>
                    <input type="range" id="cutlineZS" min="0" max="10" step="0.1" value="7.0"
                        style="width: 100%; accent-color: #ffc107;" oninput="updateCutline()">
                    <div style="font-size: 0.7em; color: #888;">ZS &gt; ì´ ê°’ â†’ ì»¤íŠ¸ë¼ì¸ ëŒ€ìƒ</div>
                </div>

                <div style="display: flex; gap: 8px;">
                    <button class="btn"
                        style="flex: 1; background: #f5576c; color: white; padding: 6px 10px; font-size: 0.85em;"
                        onclick="applyCutline()">âœ‚ï¸ ì ìš©</button>
                    <button class="btn"
                        style="flex: 1; background: #6c757d; color: white; padding: 6px 10px; font-size: 0.85em;"
                        onclick="resetCutline()">â†©ï¸ ì´ˆê¸°í™”</button>
                </div>

                <div id="cutlinePreview"
                    style="margin-top: 10px; padding: 8px; background: rgba(245,87,108,0.1); border-radius: 6px; font-size: 0.8em; color: #f5576c; display: none;">
                    ëŒ€ìƒ: <span id="cutlineCount">0</span>ê°œ
                </div>
            </div>

            <!-- ì„ íƒëœ ë‚ ì§œ ê¸°ëŠ¥ ë²„íŠ¼ -->
            <div id="dateActionsPanel"
                style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #4ecdc4;">âš¡ ì„ íƒëœ ë‚ ì§œ ì‘ì—…</h4>
                <div id="selectedDateLabel"
                    style="font-size: 0.9em; color: #fff; margin-bottom: 10px; font-weight: bold;">ğŸ“… -</div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- ë‚ ì§œ ì „ì²´ ì‘ì—… -->
                    <div>
                        <div style="font-size: 0.75em; color: #888; margin-bottom: 6px;">ğŸ“Œ ë‚ ì§œ ì „ì²´ ì‘ì—…</div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn" style="width: 100%; background: #ffc107; color: #333; padding: 8px;"
                                onclick="openDedupModal(selectedDate)">ğŸ“‹ ë¶„ë¥˜ í•˜ê¸°</button>
                            <button class="btn" style="width: 100%; background: #17a2b8; color: white; padding: 8px;"
                                onclick="resetDedupByDate(selectedDate)">â†©ï¸ ë¶„ë¥˜ ì´ˆê¸°í™”</button>
                            <button class="btn" style="width: 100%; background: #ffc107; color: #333; padding: 8px;"
                                onclick="recalculateGroup(selectedDate)">âš¡ ì ìˆ˜ ì¬ê³„ì‚°</button>
                        </div>
                    </div>

                    <!-- ì„ íƒ ê¸°ë°˜ ì‘ì—… -->
                    <div>
                        <div style="font-size: 0.75em; color: #888; margin-bottom: 6px;">â˜‘ï¸ ì„ íƒ ê¸°ì‚¬ ì‘ì—…</div>
                        <div style="display: flex; gap: 6px; margin-bottom: 6px;">
                            <button class="btn" style="flex: 1; background: #6c757d; color: white; padding: 8px;"
                                onclick="toggleDateGroup(selectedDate)">â˜‘ï¸ ì „ì²´ ì„ íƒ</button>
                            <button class="btn" style="flex: 1; background: #495057; color: white; padding: 8px;"
                                onclick="clearDateGroup(selectedDate)">â¬œ ì„ íƒ í•´ì œ</button>
                        </div>
                        <div style="display: flex; gap: 6px;">
                            <button class="btn"
                                style="flex: 1; background: #ffc107; color: #333; padding: 6px; font-size: 0.85em;"
                                onclick="rejectSelected()">ğŸš« ë¬´ì‹œ</button>
                            <button class="btn"
                                style="flex: 1; background: #dc3545; color: white; padding: 6px; font-size: 0.85em;"
                                onclick="deleteSelected()">âŒ ì‚­ì œ</button>
                            <button class="btn"
                                style="flex: 1; background: #28a745; color: white; padding: 6px; font-size: 0.85em;"
                                onclick="publishAll()">ğŸš€ ë°œí–‰</button>
                        </div>
                        <button class="btn"
                            style="width: 100%; background: #17a2b8; color: white; padding: 8px; margin-top: 6px;"
                            onclick="window.open('http://localhost:8080/preview', '_blank')">ğŸ‘ï¸ í”„ë¦¬ë·° ì‚¬ì´íŠ¸ ì—´ê¸°</button>
                    </div>

                    <!-- ìœ„í—˜ ì‘ì—… -->
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                        <div style="font-size: 0.75em; color: #888; margin-bottom: 6px;">âš ï¸ ìœ„í—˜ ì‘ì—…</div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <button class="btn" style="width: 100%; background: #dc3545; color: white; padding: 8px;"
                                onclick="rejectGroup(selectedDate)">ğŸ—‘ï¸ ë‚ ì§œ ì „ì²´ ë¬´ì‹œ</button>
                            <button class="btn" style="width: 100%; background: #6c757d; color: white; padding: 8px;"
                                onclick="clearCacheByDate(selectedDate)">ğŸ§¹ ë‚ ì§œ ìºì‹œ ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë‚ ì§œë³„ ì§„í–‰ ìƒí™© -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #ffc107;">ğŸ“… ë‚ ì§œë³„ í˜„í™©</h4>
                <div id="dateProgressList" style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="text-align: center; color: #666; padding: 20px;">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ê¸°ì‚¬ ê·¸ë¦¬ë“œ -->
        <div style="flex: 1; min-width: 0;">
            <div id="articleGrid" class="article-grid">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>

            <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
            <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3>ğŸ“„ <span id="modalTitle">íŒŒì¼ ìƒì„¸</span></h3>
                        <div style="display: flex; gap: 8px;">
                            <button id="btnRestore" class="btn"
                                style="background: #28a745; color: white; display: none;"
                                onclick="restoreCurrentArticle()">â™»ï¸ ë³µêµ¬í•˜ê¸°</button>
                            <button id="btnReject" class="btn" style="background: #dc3545; color: white;"
                                onclick="rejectCurrentArticle()">ğŸ—‘ï¸ ë¬´ì‹œí•˜ê¸°</button>
                            <button class="btn" style="background: #6c757d; color: white;"
                                onclick="deleteCurrentArticle()">âŒ ì‚­ì œí•˜ê¸°</button>
                            <button class="modal-close" onclick="closeModal()">âœ• ë‹«ê¸°</button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <pre id="jsonContent" class="json-view"></pre>
                    </div>
                </div>
            </div>

            <!-- ë¶„ë¥˜ í•˜ê¸°ìš© JSON ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ -->
            <div id="dedupModal" class="dedup-modal-overlay" onclick="closeDedupModal(event)">
                <div class="dedup-modal-content" onclick="event.stopPropagation()" style="max-width: 1400px;">
                    <div class="dedup-modal-header">
                        <div>
                            <h3>ğŸ“‹ ë¶„ë¥˜ í•˜ê¸°ìš© JSON</h3>
                            <div class="subtitle" id="dedupDateLabel">ë‚ ì§œ: -</div>
                        </div>
                        <div class="dedup-modal-actions" style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn"
                                style="background: #4285f4; color: white; padding: 8px 16px; font-size: 14px;"
                                onclick="window.open('https://gemini.google.com/gem/53a17c8f33da', '_blank')">ğŸ¤– LLM
                                ì—´ê¸°</button>
                            <button class="btn btn-copy" id="btnCopyDedup" onclick="copyDedupJson()"
                                style="padding: 8px 16px; font-size: 14px;">ğŸ“‹ ë³µì‚¬</button>
                            <button class="btn btn-apply" onclick="applyDedupResult()"
                                style="padding: 8px 16px; font-size: 14px;">âœ… ê²°ê³¼ ì ìš©</button>
                            <button class="btn modal-close" onclick="closeDedupModal()"
                                style="padding: 8px 16px; font-size: 14px;">âœ• ë‹«ê¸°</button>
                        </div>
                    </div>
                    <div class="dedup-modal-body" style="display: flex; gap: 20px; flex-direction: row;">
                        <!-- ì™¼ìª½: JSON ì¶œë ¥ -->
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div class="dedup-info" style="margin-bottom: 10px;">
                                <strong>ğŸ“¤ ë³µì‚¬í•´ì„œ LLMì— ì „ë‹¬</strong>
                            </div>
                            <pre id="dedupJsonContent" class="dedup-json-view" style="flex: 1; max-height: 60vh;"></pre>
                        </div>

                        <!-- ì˜¤ë¥¸ìª½: ë¶™ì—¬ë„£ê¸° -->
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <div class="dedup-info" style="margin-bottom: 10px;">
                                <strong>ğŸ“¥ LLM ê²°ê³¼ ë¶™ì—¬ë„£ê¸°</strong>
                            </div>
                            <textarea id="dedupPasteArea" class="paste-textarea"
                                style="flex: 1; height: auto; min-height: 300px;"
                                placeholder="LLMì´ ë°˜í™˜í•œ ê²°ê³¼ JSONì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...&#10;&#10;í˜•ì‹:&#10;{&#10;  &quot;results&quot;: [&#10;    { &quot;category&quot;: &quot;AI/ML&quot;, &quot;article_ids&quot;: [&quot;abc123&quot;, ...] },&#10;    ...&#10;  ]&#10;}"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                let stagingData = [];
                let curTimezone = 'local'; // 'local' or 'gmt'
                let selectedDate = null; // ì„ íƒëœ ë‚ ì§œ (null = ì „ì²´ í‘œì‹œ)
                let currentDetailFilename = null; // í˜„ì¬ ìƒì„¸ë³´ê¸° ì¤‘ì¸ íŒŒì¼ëª…

                function toggleTimezone(tz) {
                    curTimezone = tz;
                    renderArticles();
                }

                function selectDate(date) {
                    // ê°™ì€ ë‚ ì§œ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ (ì „ì²´ í‘œì‹œ)
                    if (selectedDate === date) {
                        selectedDate = null;
                    } else {
                        selectedDate = date;
                    }

                    // ê¸°ëŠ¥ ë²„íŠ¼ ë ˆì´ë¸” ì—…ë°ì´íŠ¸
                    const dateLabel = document.getElementById('selectedDateLabel');
                    if (selectedDate) {
                        dateLabel.textContent = `ğŸ“… ${selectedDate}`;
                    } else {
                        dateLabel.textContent = 'ğŸ“… ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”';
                    }

                    renderArticles();
                    updateDateProgress();
                }
                async function loadStaging() {
                    const grid = document.getElementById('articleGrid');
                    grid.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';

                    try {
                        // Use local time for date param
                        const now = new Date();
                        const today = now.getFullYear() + '-' +
                            String(now.getMonth() + 1).padStart(2, '0') + '-' +
                            String(now.getDate()).padStart(2, '0');
                        const response = await fetch(`/api/staging/list?date=${today}`);
                        const data = await response.json();

                        if (data.error) {
                            grid.innerHTML = `<div class="empty-state">ì˜¤ë¥˜: ${data.error}</div>`;
                            return;
                        }

                        stagingData = data.articles || [];

                        // ê°€ì¥ ìµœê·¼ ë‚ ì§œ ìë™ ì„ íƒ
                        if (stagingData.length > 0 && !selectedDate) {
                            const dates = [...new Set(stagingData.map(a => {
                                const dateRaw = a.crawled_at || a.cached_at || a.saved_at || 'Unknown';
                                if (dateRaw === 'Unknown') return null;
                                const d = new Date(dateRaw);
                                return d.getFullYear() + '-' +
                                    String(d.getMonth() + 1).padStart(2, '0') + '-' +
                                    String(d.getDate()).padStart(2, '0');
                            }).filter(d => d))].sort().reverse();

                            if (dates.length > 0) {
                                selectedDate = dates[0];
                                document.getElementById('selectedDateLabel').textContent = `ğŸ“… ${selectedDate}`;
                            }
                        }

                        renderArticles();
                        updateStats();
                    } catch (error) {
                        grid.innerHTML = `<div class="empty-state">ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
                    }
                }

                function getArticleSchema(article) {
                    return (article.impact_evidence && article.impact_evidence.schema_version) || 'Unknown';
                }

                function renderArticles() {
                    const grid = document.getElementById('articleGrid');

                    if (stagingData.length === 0) {
                        grid.innerHTML = '<div class="empty-state">Staging ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € ì¡°íŒì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>';
                        return;
                    }

                    // Group ALL data first
                    const grouped = {};
                    stagingData.forEach(article => {
                        const dateRaw = article.crawled_at || article.cached_at || article.saved_at || 'Unknown';
                        let dateKey = 'Unknown';

                        if (dateRaw !== 'Unknown') {
                            const d = new Date(dateRaw);
                            if (curTimezone === 'gmt') {
                                dateKey = d.toISOString().split('T')[0];
                            } else {
                                // Local YYYY-MM-DD
                                const year = d.getFullYear();
                                const month = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                dateKey = `${year}-${month}-${day}`;
                            }
                        }

                        if (!grouped[dateKey]) grouped[dateKey] = [];
                        grouped[dateKey].push(article);
                    });

                    // Sort Dates Descending
                    let sortedDates = Object.keys(grouped).sort().reverse();

                    // ì„ íƒëœ ë‚ ì§œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œë§Œ í‘œì‹œ
                    if (selectedDate && grouped[selectedDate]) {
                        sortedDates = [selectedDate];
                    }

                    // Get Filter Status
                    const showV1 = document.getElementById('filter-v1').checked;
                    const showHybrid = document.getElementById('filter-hybrid').checked;
                    const showV09 = document.getElementById('filter-v09').checked;
                    const showLegacy = document.getElementById('filter-legacy').checked;

                    let html = '';

                    sortedDates.forEach(date => {
                        const allArticles = grouped[date];

                        // Filter articles for this specific group
                        const visibleArticles = allArticles.filter(article => {
                            const schema = getArticleSchema(article);
                            if (schema === 'V1.0' && !showV1) return false;
                            if (schema === 'V0.9-Hybrid' && !showHybrid) return false;
                            if (schema === 'V0.9' && !showV09) return false;
                            if ((schema === 'Legacy' || schema === 'Unknown') && !showLegacy) return false;
                            return true;
                        });

                        // ì¹´í…Œê³ ë¦¬ ìˆœì„œ: ë¯¸ë¶„ë¥˜(null) â†’ ê° ì¹´í…Œê³ ë¦¬ ì•ŒíŒŒë²³ìˆœ â†’ ì¤‘ë³µ/ê±°ë¶€ë¨/ë°œí–‰ë¨
                        // ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œëŠ” Priority ë‚´ë¦¼ì°¨ìˆœ
                        visibleArticles.sort((a, b) => {
                            // ì¤‘ë³µ/ê±°ë¶€ë¨/ë°œí–‰ë¨ì€ ë§¨ ë’¤ë¡œ
                            const aIsInactive = a.dedup_status === 'duplicate' || a.rejected || a.published;
                            const bIsInactive = b.dedup_status === 'duplicate' || b.rejected || b.published;
                            if (aIsInactive && !bIsInactive) return 1;
                            if (!aIsInactive && bIsInactive) return -1;

                            // ë¯¸ë¶„ë¥˜(ì¹´í…Œê³ ë¦¬ ì—†ìŒ)ë¥¼ ê°€ì¥ ìœ„ë¡œ
                            const aCat = a.category || '';
                            const bCat = b.category || '';
                            if (!aCat && bCat) return -1;
                            if (aCat && !bCat) return 1;

                            // ì¹´í…Œê³ ë¦¬ ì•ŒíŒŒë²³ìˆœ
                            if (aCat !== bCat) return aCat.localeCompare(bCat);

                            // ê°™ì€ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ Priority(ISÃ—0.5 + IS/ZS) ìˆœ
                            const aIS = a.impact_score || 0;
                            const aZS = a.zero_echo_score || 0.1;
                            const bIS = b.impact_score || 0;
                            const bZS = b.zero_echo_score || 0.1;
                            const aPriority = (aIS * 0.5) + (aIS / aZS);
                            const bPriority = (bIS * 0.5) + (bIS / bZS);
                            return bPriority - aPriority;
                        });

                        const hiddenCount = allArticles.length - visibleArticles.length;

                        // Render Header ALWAYS (User Requirement)
                        html += `
                    <div style="width:100%; margin-top:20px; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin:0; color:#4ecdc4;">ğŸ“… ${date} <span style="font-size:0.7em; color:#aaa;">(${visibleArticles.length} í‘œì‹œ / ${allArticles.length} ì „ì²´)</span></h3>
                        <select id="schemaSelect-${date}" class="btn" style="padding: 4px 8px; background: #343a40; color: white; border: 1px solid #6c757d;">
                            <option value="" selected>ìë™ ê°ì§€ (Auto)</option>
                            <option value="V0.9-Hybrid">V0.9 (ìˆ˜ë™/Hybrid)</option>
                            <option value="V1.0">V1.0 (í‘œì¤€)</option>
                            <option value="V0.9">V0.9 (êµ¬í˜•/Standard)</option>
                        </select>
                    </div>
                `;

                        // Render Articles
                        if (visibleArticles.length === 0) {
                            html += `<div style="padding:20px; text-align:center; color:#666; font-style:italic; border-bottom:1px dashed #444; margin-bottom:10px;">ì´ ë‚ ì§œì— í‘œì‹œí•  ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤. (${hiddenCount}ê°œ ìˆ¨ê²¨ì§)</div>`;
                        } else {
                            html += visibleArticles.map(article => {
                                // ìƒíƒœ ê²°ì •: ì¤‘ë³µ > ê±°ë¶€ë¨ > ë°œí–‰ë¨ > ëŒ€ê¸°ì¤‘
                                const isDuplicate = article.dedup_status === 'duplicate';
                                let cardClass, statusClass, statusText, canSelect;

                                if (isDuplicate) {
                                    cardClass = 'duplicate';
                                    statusClass = 'duplicate';
                                    statusText = 'ì¤‘ë³µ';
                                    canSelect = false;
                                } else if (article.rejected) {
                                    cardClass = 'rejected';
                                    statusClass = 'rejected';
                                    statusText = 'ê±°ë¶€ë¨';
                                    canSelect = false;
                                } else if (article.published) {
                                    cardClass = 'published';
                                    statusClass = 'published';
                                    statusText = 'ë°œí–‰ë¨';
                                    canSelect = false;
                                } else {
                                    // ì¹´í…Œê³ ë¦¬ë³„ í´ë˜ìŠ¤ ë§¤í•‘
                                    const catClassMap = {
                                        'AI/ML': 'cat-ai-ml',
                                        'Engineering': 'cat-engineering',
                                        'Community': 'cat-community',
                                        'Business': 'cat-business'
                                    };
                                    const catClass = article.category ? (catClassMap[article.category] || '') : 'cat-uncategorized';
                                    cardClass = catClass;
                                    statusClass = 'staged';
                                    statusText = article.category ? `ğŸ“‚ ${article.category}` : 'â³ ë¯¸ë¶„ë¥˜';
                                    canSelect = true;
                                }

                                const checkboxHtml = canSelect
                                    ? `<input type="checkbox" class="article-checkbox" data-filename="${article.filename}" data-date="${date}" onclick="toggleCheck(event)" onchange="updateSelectedCount()" style="width:18px; height:18px; cursor:pointer;">`
                                    : '';

                                let schemaVer = getArticleSchema(article);
                                let badgeClass = 'schema-unknown';
                                let badgeText = schemaVer;

                                if (schemaVer === 'V1.0') { badgeClass = 'schema-v1'; }
                                else if (schemaVer === 'V0.9') { badgeClass = 'schema-v09'; }
                                else if (schemaVer === 'V0.9-Hybrid') { badgeClass = 'schema-hybrid'; badgeText = 'Hybrid'; }
                                else if (schemaVer === 'Legacy') { badgeClass = 'schema-legacy'; }

                                if (badgeText === 'Unknown') badgeText = '';

                                // Time display
                                const dateRaw = article.crawled_at || article.cached_at || 'Unknown';
                                let timeStr = '';
                                if (dateRaw !== 'Unknown') {
                                    const d = new Date(dateRaw);
                                    if (curTimezone === 'gmt') {
                                        // e.g. 15:04:05 (GMT)
                                        timeStr = d.toISOString().substring(11, 19) + ' (GMT)';
                                    } else {
                                        // e.g. 15:04:05
                                        timeStr = d.toTimeString().split(' ')[0];
                                    }
                                }

                                return `
                            <div class="article-card ${cardClass}" onclick="showDetail('${article.filename}')">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <div style="display:flex; align-items:center;">
                                        ${badgeText ? `<span class="schema-badge ${badgeClass}">${badgeText}</span>` : ''}
                                        <span style="font-size: 0.75em; color: #888; margin-right:5px;">${timeStr}</span>
                                        <span style="font-size: 0.75em; color: #666;">ğŸ“ ${article.article_id || article.filename?.replace('.json', '') || '-'}</span>
                                    </div>
                                    ${checkboxHtml}
                                </div>
                                <div class="article-title">${article.title_ko || article.title || 'ì œëª© ì—†ìŒ'}</div>
                                <div class="article-summary">${(article.summary || '').slice(0, 150)}...</div>
                                <div class="article-meta">
                                    <span class="score-badge score-is" data-article-id="${article.article_id || article.filename?.replace('.json', '') || ''}">IS: ${article.impact_score?.toFixed(1) || '-'}</span>
                                    <span class="score-badge score-zs" data-article-id="${article.article_id || article.filename?.replace('.json', '') || ''}">ZS: ${article.zero_echo_score?.toFixed(1) || '-'}</span>
                                    <span class="status-badge status-${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        `;
                            }).join('');
                        }
                    });

                    grid.innerHTML = html;
                }

                function updateStats() {
                    // ì „ì²´ í†µê³„
                    const staged = stagingData.filter(a => !a.rejected && !a.published && a.dedup_status !== 'duplicate').length;
                    const rejected = stagingData.filter(a => a.rejected || a.dedup_status === 'duplicate').length;
                    const published = stagingData.filter(a => a.published).length;

                    document.getElementById('stagedCount').textContent = staged;
                    document.getElementById('rejectedCount').textContent = rejected;
                    document.getElementById('publishedCount').textContent = published;

                    // ë‚ ì§œë³„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    updateDateProgress();
                }

                function updateDateProgress() {
                    const dateProgressList = document.getElementById('dateProgressList');
                    if (!dateProgressList) return;

                    // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”
                    const grouped = {};
                    stagingData.forEach(article => {
                        const dateRaw = article.crawled_at || article.cached_at || article.saved_at || 'Unknown';
                        if (dateRaw === 'Unknown') return;

                        const d = new Date(dateRaw);
                        let dateStr;
                        if (curTimezone === 'gmt') {
                            dateStr = d.toISOString().split('T')[0];
                        } else {
                            dateStr = d.getFullYear() + '-' +
                                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                                String(d.getDate()).padStart(2, '0');
                        }

                        if (!grouped[dateStr]) grouped[dateStr] = [];
                        grouped[dateStr].push(article);
                    });

                    const sortedDates = Object.keys(grouped).sort().reverse();

                    if (sortedDates.length === 0) {
                        dateProgressList.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">ë°ì´í„° ì—†ìŒ</div>';
                        return;
                    }

                    // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë§µ
                    const catColors = {
                        'AI/ML': '#667eea',
                        'Engineering': '#f5576c',
                        'Community': '#4facfe',
                        'Business': '#43e97b'
                    };

                    dateProgressList.innerHTML = sortedDates.map(date => {
                        const articles = grouped[date];
                        const total = articles.length;
                        const pending = articles.filter(a => !a.rejected && !a.published && a.dedup_status !== 'duplicate').length;
                        const duplicate = articles.filter(a => a.dedup_status === 'duplicate').length;
                        const categorized = articles.filter(a => a.category && a.dedup_status !== 'duplicate').length;
                        const uncategorized = articles.filter(a => !a.category && !a.rejected && !a.published && a.dedup_status !== 'duplicate').length;

                        // ì¹´í…Œê³ ë¦¬ë³„ ê°œìˆ˜
                        const catCounts = {};
                        articles.filter(a => a.category && a.dedup_status !== 'duplicate').forEach(a => {
                            catCounts[a.category] = (catCounts[a.category] || 0) + 1;
                        });

                        const catBadges = Object.entries(catCounts).map(([cat, count]) =>
                            `<span style="background: ${catColors[cat] || '#6c757d'}; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7em; margin-right: 3px;">${cat}: ${count}</span>`
                        ).join('');

                        // ì„ íƒ ìƒíƒœ ìŠ¤íƒ€ì¼
                        const isSelected = selectedDate === date;
                        const cardStyle = isSelected
                            ? 'background: rgba(78,205,196,0.2); border: 2px solid #4ecdc4; border-radius: 8px; padding: 10px; cursor: pointer;'
                            : 'background: rgba(255,255,255,0.03); border: 2px solid transparent; border-radius: 8px; padding: 10px; cursor: pointer;';

                        return `
                            <div style="${cardStyle}" onclick="selectDate('${date}')">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span style="font-weight: bold; color: ${isSelected ? '#4ecdc4' : '#fff'};">ğŸ“… ${date}</span>
                                    <span style="font-size: 0.8em; color: #888;">${pending}/${total}</span>
                                </div>
                                ${uncategorized > 0 ? `<div style="margin-bottom: 5px;"><span style="background: #ffc107; color: #333; padding: 1px 6px; border-radius: 8px; font-size: 0.7em;">â³ ë¯¸ë¶„ë¥˜: ${uncategorized}</span></div>` : ''}
                                ${catBadges ? `<div style="margin-bottom: 5px;">${catBadges}</div>` : ''}
                                ${duplicate > 0 ? `<div><span style="background: #6c757d; color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7em;">ğŸ—‘ï¸ ì¤‘ë³µ: ${duplicate}</span></div>` : ''}
                            </div>
                        `;
                    }).join('');
                }

                function scrollToDate(date) {
                    // í•´ë‹¹ ë‚ ì§œ í—¤ë”ë¡œ ìŠ¤í¬ë¡¤
                    const headers = document.querySelectorAll('h3');
                    for (const h of headers) {
                        if (h.textContent.includes(date)) {
                            h.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            break;
                        }
                    }
                }

                async function resetDedupByDate(date) {
                    if (!confirm(`âš ï¸ [${date}] ê¸°ì‚¬ë“¤ì˜ ì¤‘ë³µ/ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/staging/reset_dedup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date: date })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… [${date}] ì¤‘ë³µ ì´ˆê¸°í™” ì™„ë£Œ!\n\n${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                // ==== ì»¤íŠ¸ë¼ì¸ ê¸°ëŠ¥ ====
                function updateCutline() {
                    const isValue = parseFloat(document.getElementById('cutlineIS').value);
                    const zsValue = parseFloat(document.getElementById('cutlineZS').value);

                    document.getElementById('cutlineISValue').textContent = isValue.toFixed(1);
                    document.getElementById('cutlineZSValue').textContent = zsValue.toFixed(1);

                    // ëŒ€ìƒ ê¸°ì‚¬ë³„ ì¡°ê±´ ì €ì¥ (IS/ZS ì¤‘ ì–´ë–¤ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ”ì§€)
                    const targetIS = new Set(); // IS < value ì¡°ê±´ í•´ë‹¹
                    const targetZS = new Set(); // ZS > value ì¡°ê±´ í•´ë‹¹
                    let targetCount = 0;

                    stagingData.forEach(a => {
                        if (a.rejected || a.published || a.dedup_status === 'duplicate') return;
                        const is = a.impact_score || 0;
                        const zs = a.zero_echo_score || 0;
                        const articleId = a.article_id || a.filename?.replace('.json', '') || '';

                        let isTarget = false;
                        if (is < isValue) {
                            targetIS.add(articleId);
                            isTarget = true;
                        }
                        if (zs > zsValue) {
                            targetZS.add(articleId);
                            isTarget = true;
                        }
                        if (isTarget) targetCount++;
                    });

                    // ëª¨ë“  ì ìˆ˜ ë°°ì§€ì—ì„œ cutline-target í´ë˜ìŠ¤ ì œê±° í›„, í•´ë‹¹ ì¡°ê±´ì—ë§Œ ì¶”ê°€
                    document.querySelectorAll('.score-badge.score-is').forEach(badge => {
                        const badgeId = badge.dataset.articleId || '';
                        if (targetIS.has(badgeId)) {
                            badge.classList.add('cutline-target');
                        } else {
                            badge.classList.remove('cutline-target');
                        }
                    });
                    document.querySelectorAll('.score-badge.score-zs').forEach(badge => {
                        const badgeId = badge.dataset.articleId || '';
                        if (targetZS.has(badgeId)) {
                            badge.classList.add('cutline-target');
                        } else {
                            badge.classList.remove('cutline-target');
                        }
                    });

                    const preview = document.getElementById('cutlinePreview');
                    const countSpan = document.getElementById('cutlineCount');
                    if (targetCount > 0) {
                        preview.style.display = 'block';
                        countSpan.textContent = targetCount;
                    } else {
                        preview.style.display = 'none';
                    }
                }

                async function applyCutline() {
                    const isValue = parseFloat(document.getElementById('cutlineIS').value);
                    const zsValue = parseFloat(document.getElementById('cutlineZS').value);

                    // ëŒ€ìƒ ê¸°ì‚¬ ì°¾ê¸°
                    const targets = stagingData.filter(a => {
                        if (a.rejected || a.published || a.dedup_status === 'duplicate') return false;
                        const is = a.impact_score || 0;
                        const zs = a.zero_echo_score || 0;
                        return is < isValue || zs > zsValue;
                    });

                    if (targets.length === 0) {
                        alert('ì»¤íŠ¸ë¼ì¸ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    if (!confirm(`âš ï¸ ${targets.length}ê°œ ê¸°ì‚¬ë¥¼ ì»¤íŠ¸ë¼ì¸ ì²˜ë¦¬(ê±°ë¶€)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì¡°ê±´:\nâ€¢ IS < ${isValue.toFixed(1)}\nâ€¢ ZS > ${zsValue.toFixed(1)}`)) {
                        return;
                    }

                    try {
                        const filenames = targets.map(a => a.filename);
                        const response = await fetch('/api/staging/reject_selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames })
                        });

                        const result = await response.json();
                        if (result.success) {
                            alert(`âœ… ${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                function resetCutline() {
                    document.getElementById('cutlineIS').value = 3.0;
                    document.getElementById('cutlineZS').value = 7.0;
                    updateCutline();
                }

                async function publishAll() {
                    // Check only Visible checkboxes
                    const checkboxes = document.querySelectorAll('.article-checkbox:checked');
                    const selectedFiles = Array.from(checkboxes).map(cb => cb.dataset.filename);

                    if (selectedFiles.length === 0) {
                        alert('ë°œí–‰í•  ê¸°ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    if (!confirm(`${selectedFiles.length}ê°œ ê¸°ì‚¬ë¥¼ ë°œí–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/staging/publish_selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames: selectedFiles })
                        });
                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ë°œí–‰ ì™„ë£Œ!\n\n${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ë°œí–‰ ì‹¤íŒ¨\n\n${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function rejectSelected() {
                    const checkboxes = document.querySelectorAll('.article-checkbox:checked');
                    const selectedFiles = Array.from(checkboxes).map(cb => cb.dataset.filename);

                    if (selectedFiles.length === 0) {
                        alert('ë¬´ì‹œí•  ê¸°ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    if (!confirm(`${selectedFiles.length}ê°œ ê¸°ì‚¬ë¥¼ ë¬´ì‹œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/staging/reject_selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames: selectedFiles })
                        });
                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ë¬´ì‹œ ì²˜ë¦¬ ì™„ë£Œ!\n\n${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨\n\n${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function deleteSelected() {
                    const checkboxes = document.querySelectorAll('.article-checkbox:checked');
                    const selectedFiles = Array.from(checkboxes).map(cb => cb.dataset.filename);

                    if (selectedFiles.length === 0) {
                        alert('ì‚­ì œí•  ê¸°ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    if (!confirm(`âš ï¸ ${selectedFiles.length}ê°œ ê¸°ì‚¬ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                        return;
                    }

                    try {
                        let deleted = 0;
                        let failed = 0;

                        for (const filename of selectedFiles) {
                            const response = await fetch('/api/staging/delete_file', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ filename: filename, date: selectedDate })
                            });
                            const result = await response.json();
                            if (result.success) {
                                deleted++;
                            } else {
                                failed++;
                            }
                        }

                        alert(`âœ… ì‚­ì œ ì™„ë£Œ!\n\nì‚­ì œ: ${deleted}ê°œ, ì‹¤íŒ¨: ${failed}ê°œ`);
                        loadStaging();
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function showDetail(filename) {
                    const modal = document.getElementById('detailModal');
                    const titleEl = document.getElementById('modalTitle');
                    const contentEl = document.getElementById('jsonContent');
                    const btnRestore = document.getElementById('btnRestore');
                    const btnReject = document.getElementById('btnReject');

                    currentDetailFilename = filename; // í˜„ì¬ íŒŒì¼ëª… ì €ì¥
                    titleEl.textContent = filename;
                    contentEl.textContent = 'ë¡œë”© ì¤‘...';
                    modal.classList.add('active');

                    try {
                        const now = new Date();
                        const today = now.getFullYear() + '-' +
                            String(now.getMonth() + 1).padStart(2, '0') + '-' +
                            String(now.getDate()).padStart(2, '0');
                        const response = await fetch(`/api/staging/file?date=${today}&filename=${filename}`);
                        const data = await response.json();

                        if (data.error) {
                            contentEl.textContent = `ì˜¤ë¥˜: ${data.error}`;
                        } else {
                            contentEl.textContent = JSON.stringify(data, null, 2);

                            // ê±°ë¶€ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
                            if (data.rejected) {
                                btnRestore.style.display = 'inline-block';
                                btnReject.style.display = 'none';
                            } else {
                                btnRestore.style.display = 'none';
                                btnReject.style.display = 'inline-block';
                            }
                        }
                    } catch (error) {
                        contentEl.textContent = `ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                    }
                }

                function closeModal(event) {
                    if (event && event.target !== event.currentTarget) return;
                    document.getElementById('detailModal').classList.remove('active');
                    currentDetailFilename = null;
                }

                async function rejectCurrentArticle() {
                    if (!currentDetailFilename) return;

                    if (!confirm(`âš ï¸ "${currentDetailFilename}"ì„(ë¥¼) ë¬´ì‹œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                    try {
                        const response = await fetch('/api/staging/reject_selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames: [currentDetailFilename] })
                        });
                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ë¬´ì‹œ ì²˜ë¦¬ ì™„ë£Œ!`);
                            closeModal();
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function restoreCurrentArticle() {
                    if (!currentDetailFilename) return;

                    if (!confirm(`â™»ï¸ "${currentDetailFilename}"ì„(ë¥¼) ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                    try {
                        const response = await fetch('/api/staging/restore_selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filenames: [currentDetailFilename], date: selectedDate })
                        });
                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ë³µêµ¬ ì™„ë£Œ!`);
                            closeModal();
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function deleteCurrentArticle() {
                    if (!currentDetailFilename) return;

                    if (!confirm(`âš ï¸ "${currentDetailFilename}"ì„(ë¥¼) ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;

                    try {
                        const response = await fetch('/api/staging/delete_file', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: currentDetailFilename, date: selectedDate })
                        });
                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ì‚­ì œ ì™„ë£Œ!`);
                            closeModal();
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                function toggleCheck(event, filename) {
                    event.stopPropagation();
                }

                function updateSelectedCount() {
                    const checkboxes = document.querySelectorAll('.article-checkbox:checked');
                    const count = checkboxes.length;
                    const btn = document.querySelector('.btn-publish');
                    btn.textContent = count > 0 ? `ğŸš€ ì„ íƒ ë°œí–‰ (${count})` : 'ğŸš€ ì„ íƒ ë°œí–‰';
                }

                function toggleSelectAll() {
                    const checkboxes = document.querySelectorAll('.article-checkbox');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    checkboxes.forEach(cb => cb.checked = !allChecked);
                    updateSelectedCount();
                }

                function toggleDateGroup(date) {
                    const checkboxes = document.querySelectorAll(`.article-checkbox[data-date="${date}"]`);
                    if (checkboxes.length === 0) return; // Nothing to toggle

                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    checkboxes.forEach(cb => cb.checked = !allChecked);
                    updateSelectedCount();
                }

                function clearDateGroup(date) {
                    const checkboxes = document.querySelectorAll(`.article-checkbox[data-date="${date}"]`);
                    checkboxes.forEach(cb => cb.checked = false);
                    updateSelectedCount();
                }

                async function clearCacheByDate(date) {
                    if (!date) {
                        alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    if (!confirm(`âš ï¸ [${date}] ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìºì‹œ ì‚­ì œ í›„ì—ëŠ” í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì‚¬ë¥¼ ë‹¤ì‹œ ë¶„ì„í•´ì•¼ í•©ë‹ˆë‹¤.`)) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/staging/clear_cache', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date: date })
                        });
                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ìºì‹œ ì‚­ì œ ì™„ë£Œ!\n\n${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function recalculateGroup(date) {
                    const checkboxes = document.querySelectorAll(`.article-checkbox[data-date="${date}"]`);
                    // Note: This only selects visible checkboxes because hidden ones are not in DOM.
                    // This is desired behavior: Only recalculate what I can see.
                    const filenames = Array.from(checkboxes).map(cb => cb.dataset.filename);

                    const schemaSelect = document.getElementById(`schemaSelect-${date}`);
                    const selectedSchema = schemaSelect ? schemaSelect.value : null;

                    if (filenames.length === 0) {
                        alert('ì¬ê³„ì‚°í•  ê°€ëŠ¥í•œ ê¸°ì‚¬ê°€ ì´ ê·¸ë£¹ì— ì—†ìŠµë‹ˆë‹¤ (í•„í„°ë§ë¨?).');
                        return;
                    }

                    let msg = `[${date}] ê·¸ë£¹ì˜ ${filenames.length}ê°œ ê¸°ì‚¬ ì ìˆ˜ë¥¼ ì¬ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (selectedSchema) msg += `\n(ì ìš© ìŠ¤í‚¤ë§ˆ: ${selectedSchema})`;

                    if (!confirm(msg)) {
                        return;
                    }

                    try {
                        document.getElementById('articleGrid').innerHTML = '<div class="loading">ì ìˆ˜ ì¬ê³„ì‚° ì¤‘...</div>';

                        const response = await fetch('/api/staging/recalculate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                date: new Date().getFullYear() + '-' + String(new Date().getMonth() + 1).padStart(2, '0') + '-' + String(new Date().getDate()).padStart(2, '0'),
                                filenames: filenames,
                                schema_version: selectedSchema
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ì¬ê³„ì‚° ì™„ë£Œ: ${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                            loadStaging();
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                        loadStaging();
                    }
                }

                async function rejectGroup(date) {
                    const checkboxes = document.querySelectorAll(`.article-checkbox[data-date="${date}"]`);
                    // Only Visible
                    const filenames = Array.from(checkboxes).map(cb => cb.dataset.filename);

                    if (filenames.length === 0) {
                        alert('ê±°ë¶€í•  ê°€ëŠ¥í•œ ê¸°ì‚¬ê°€ ì´ ê·¸ë£¹ì— ì—†ìŠµë‹ˆë‹¤ (í•„í„°ë§ë¨?).');
                        return;
                    }

                    if (!confirm(`âš ï¸ [${date}] ê·¸ë£¹ì˜ ${filenames.length}ê°œ ê¸°ì‚¬ë¥¼ ëª¨ë‘ 'ê±°ë¶€(Reject)' ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                        return;
                    }

                    try {
                        document.getElementById('articleGrid').innerHTML = '<div class="loading">ì¼ê´„ ê±°ë¶€ ì²˜ë¦¬ ì¤‘...</div>';

                        const response = await fetch('/api/staging/reject_selected', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                filenames: filenames
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ì²˜ë¦¬ ì™„ë£Œ: ${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                            loadStaging();
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                        loadStaging();
                    }
                }

                async function resetDedupStatus() {
                    if (!confirm('âš ï¸ ëª¨ë“  ê¸°ì‚¬ì˜ ì¤‘ë³µ/ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                        return;
                    }

                    try {
                        const now = new Date();
                        const today = now.getFullYear() + '-' +
                            String(now.getMonth() + 1).padStart(2, '0') + '-' +
                            String(now.getDate()).padStart(2, '0');

                        const response = await fetch('/api/staging/reset_dedup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date: today })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… ì´ˆê¸°í™” ì™„ë£Œ!\n\n${result.message}`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                async function deleteLegacyCalls() {
                    if (!confirm('âš ï¸ ëª¨ë“  LEGACY_CALL ê¸°ì‚¬ë¥¼ stagingê³¼ cacheì—ì„œ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/staging/delete_legacy', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`âœ… LEGACY ì‚­ì œ ì™„ë£Œ!\n\nStaging: ${result.deleted_staging}ê°œ\nCache: ${result.deleted_cache}ê°œ`);
                            loadStaging();
                        } else {
                            alert(`âŒ ì‹¤íŒ¨: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`âŒ ì˜¤ë¥˜: ${error.message}`);
                    }
                }

                // ==== ì¤‘ë³µ ì²´í¬ìš© JSON ê¸°ëŠ¥ ====
                let currentDedupDate = null;
                let currentDedupArticles = [];

                async function openDedupModal(date) {
                    currentDedupDate = date;
                    const modal = document.getElementById('dedupModal');
                    const dateLabel = document.getElementById('dedupDateLabel');
                    const contentEl = document.getElementById('dedupJsonContent');
                    const pasteArea = document.getElementById('dedupPasteArea');

                    dateLabel.textContent = `ë‚ ì§œ: ${date}`;
                    pasteArea.value = '';
                    contentEl.textContent = 'ë¡œë”© ì¤‘...';
                    modal.classList.add('active');

                    // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
                    let categories = [];
                    try {
                        const catResp = await fetch('/api/dedup_categories');
                        const catData = await catResp.json();
                        categories = catData.categories || [];
                    } catch (e) {
                        console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', e);
                        categories = ["AI/ML", "Cloud/Infra", "Security", "Business", "Hardware", "Software", "Research", "Policy", "Startup", "Other"];
                    }

                    // í•´ë‹¹ ë‚ ì§œì˜ ê¸°ì‚¬ë“¤ í•„í„°ë§ (ëŒ€ê¸° ì¤‘ì¸ ê²ƒë§Œ)
                    currentDedupArticles = stagingData.filter(article => {
                        const dateRaw = article.crawled_at || article.cached_at || article.saved_at || 'Unknown';
                        if (dateRaw === 'Unknown') return false;

                        const d = new Date(dateRaw);
                        let articleDate;
                        if (curTimezone === 'gmt') {
                            articleDate = d.toISOString().split('T')[0];
                        } else {
                            articleDate = d.getFullYear() + '-' +
                                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                                String(d.getDate()).padStart(2, '0');
                        }

                        return articleDate === date && !article.rejected && !article.published;
                    });

                    // ê°„ê²°í•œ JSON ìƒì„± (Priority = ISÃ—0.5 + IS/ZS ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬)
                    // LEGACY_CALL ì œì™¸
                    const articles = currentDedupArticles
                        .filter(article => {
                            const articleId = article.article_id || article.filename?.replace('.json', '') || '';
                            return articleId !== 'LEGACY_CALL' && !articleId.includes('LEGACY');
                        })
                        .map(article => {
                            const is = article.impact_score || 0;
                            const zs = article.zero_echo_score || 0.1; // 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
                            const priority = (is * 0.5) + (is / zs);
                            return {
                                id: article.article_id || article.filename?.replace('.json', '') || '-',
                                title: article.title_ko || article.title || '',
                                summary: article.summary || '',
                                IS: is.toFixed(1),
                                ZS: zs.toFixed(1),
                                Priority: priority.toFixed(2)
                            };
                        })
                        .sort((a, b) => parseFloat(b.Priority) - parseFloat(a.Priority));

                    // categories + articles êµ¬ì¡°ë¡œ ì¶œë ¥
                    const dedupOutput = {
                        categories: categories,
                        articles: articles
                    };

                    contentEl.textContent = JSON.stringify(dedupOutput, null, 2);

                    // ë³µì‚¬ ë²„íŠ¼ ì´ˆê¸°í™”
                    const copyBtn = document.getElementById('btnCopyDedup');
                    copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                    copyBtn.classList.remove('copied');
                }

                function closeDedupModal(event) {
                    if (event && event.target !== event.currentTarget) return;
                    document.getElementById('dedupModal').classList.remove('active');
                    currentDedupDate = null;
                    currentDedupArticles = [];
                }

                async function copyDedupJson() {
                    const contentEl = document.getElementById('dedupJsonContent');
                    const copyBtn = document.getElementById('btnCopyDedup');

                    try {
                        await navigator.clipboard.writeText(contentEl.textContent);
                        copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                        copyBtn.classList.add('copied');

                        setTimeout(() => {
                            copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    } catch (err) {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = contentEl.textContent;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);

                        copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                        copyBtn.classList.add('copied');

                        setTimeout(() => {
                            copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    }
                }

                async function applyDedupResult() {
                    const pasteArea = document.getElementById('dedupPasteArea');
                    const rawInput = pasteArea.value.trim();

                    if (!rawInput) {
                        alert('ë¶™ì—¬ë„£ê¸° ì˜ì—­ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                        return;
                    }

                    let parsed;
                    try {
                        parsed = JSON.parse(rawInput);
                    } catch (e) {
                        alert('JSON íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
                        return;
                    }

                    // ìƒˆ í˜•ì‹: { results: [{ category, article_ids }, ...] }
                    // êµ¬ í˜•ì‹: [{ id, category }, ...]
                    let survivorIds = new Set();
                    let categoryMap = {}; // article_id -> category

                    if (parsed.results && Array.isArray(parsed.results)) {
                        // ìƒˆ í˜•ì‹ ì²˜ë¦¬
                        parsed.results.forEach(group => {
                            const category = group.category || 'Unknown';
                            const ids = group.article_ids || [];
                            ids.forEach(id => {
                                survivorIds.add(id);
                                categoryMap[id] = category;
                            });
                        });
                    } else if (Array.isArray(parsed)) {
                        // êµ¬ í˜•ì‹ í˜¸í™˜ ì²˜ë¦¬
                        parsed.forEach(item => {
                            const id = item.id || item.article_id;
                            if (id) {
                                survivorIds.add(id);
                                if (item.category) categoryMap[id] = item.category;
                            }
                        });
                    } else {
                        alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.');
                        return;
                    }

                    if (survivorIds.size === 0) {
                        alert('ì‚´ì•„ë‚¨ì€ ê¸°ì‚¬ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // ë³´ë‚¸ ê¸°ì‚¬(currentDedupArticles)ë§Œ ì¹´í…Œê³ ë¦¬ì™€ ì¤‘ë³µ ì •ë³´ ë°˜ì˜
                    let selectedCount = 0;
                    let duplicateCount = 0;

                    currentDedupArticles.forEach(article => {
                        // article_idë¥¼ JSONì—ì„œ ë³´ë‚¸ ê²ƒê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì¶”ì¶œ
                        // ìš°ì„ ìˆœìœ„: article.article_id > filenameì—ì„œ ì¶”ì¶œ
                        const articleId = article.article_id || (() => {
                            const parts = article.filename?.replace('.json', '').split('_') || [];
                            return parts.length > 1 ? parts[parts.length - 1] : parts[0] || '';
                        })();

                        console.log(`[Dedup] ID ë§¤ì¹­: articleId="${articleId}", survivorIds has it: ${survivorIds.has(articleId)}`);

                        if (survivorIds.has(articleId)) {
                            article._dedup_category = categoryMap[articleId] || null;
                            article._dedup_duplicate = false;
                            selectedCount++;
                        } else {
                            article._dedup_duplicate = true;
                            article._dedup_category = null;
                            duplicateCount++;
                        }

                        // Priority ê³„ì‚°
                        const is = article.impact_score || 0;
                        const zs = article.zero_echo_score || 0.1;
                        article._priority = (is * 0.5) + (is / zs);
                    });

                    // ì„œë²„ì— ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥
                    try {
                        // ë³´ë‚¸ ê¸°ì‚¬ ID ëª©ë¡ ì¶”ì¶œ
                        const sentIds = currentDedupArticles.map(a =>
                            a.article_id || (() => {
                                const parts = a.filename?.replace('.json', '').split('_') || [];
                                return parts.length > 1 ? parts[parts.length - 1] : parts[0] || '';
                            })()
                        );

                        const saveResp = await fetch('/api/staging/update_categories', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                date: currentDedupDate,
                                results: parsed.results || [],
                                sent_ids: sentIds  // LLMì— ë³´ë‚¸ ê¸°ì‚¬ ID ëª©ë¡
                            })
                        });
                        const saveResult = await saveResp.json();
                        if (saveResult.success) {
                            console.log(`ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì €ì¥ ì™„ë£Œ: ${saveResult.message}`);
                        } else {
                            console.error('ì¹´í…Œê³ ë¦¬ ì €ì¥ ì‹¤íŒ¨:', saveResult.error);
                        }
                    } catch (e) {
                        console.error('ì¹´í…Œê³ ë¦¬ ì €ì¥ API ì˜¤ë¥˜:', e);
                    }

                    // ë‚ ì§œ ì €ì¥ (closeDedupModalì—ì„œ nullë¡œ ì´ˆê¸°í™”ë˜ê¸° ì „ì—)
                    const targetDate = currentDedupDate;

                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeDedupModal();

                    // ì„œë²„ì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ í†µì¼ëœ ë Œë”ë§ ì‚¬ìš©
                    await loadStaging();

                    // ê²°ê³¼ ë©”ì‹œì§€
                    let message = `âœ… ì¤‘ë³µ ì œê±° ì™„ë£Œ!\n\nì„ íƒë¨: ${selectedCount}ê°œ\nì¤‘ë³µ ì²˜ë¦¬: ${duplicateCount}ê°œ`;

                    // ì¹´í…Œê³ ë¦¬ë³„ ê°œìˆ˜ í‘œì‹œ
                    if (parsed.results) {
                        const categoryStats = parsed.results.map(g => `${g.category}: ${g.article_ids?.length || 0}ê°œ`).join('\n');
                        message += `\n\nğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ë°°ë¶„:\n${categoryStats}`;
                    }

                    alert(message);
                }

                // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™” ë Œë”ë§
                function renderDedupedArticles(date, categoryResults) {
                    const grid = document.getElementById('articleGrid');

                    // í•´ë‹¹ ë‚ ì§œ ê¸°ì‚¬ë§Œ í•„í„°
                    const dateArticles = stagingData.filter(article => {
                        const dateRaw = article.crawled_at || article.cached_at || article.saved_at || 'Unknown';
                        if (dateRaw === 'Unknown') return false;

                        const d = new Date(dateRaw);
                        let articleDate;
                        if (curTimezone === 'gmt') {
                            articleDate = d.toISOString().split('T')[0];
                        } else {
                            articleDate = d.getFullYear() + '-' +
                                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                                String(d.getDate()).padStart(2, '0');
                        }
                        return articleDate === date;
                    });

                    // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë§µ
                    const catColors = {
                        'AI/ML': 'cat-ai-ml',
                        'Engineering': 'cat-engineering',
                        'Community': 'cat-community',
                        'Business': 'cat-business'
                    };

                    let html = '';

                    // í—¤ë”
                    html += `
                <div style="width:100%; margin-top:20px; margin-bottom:10px; border-bottom:2px solid #ffc107; padding-bottom:10px;">
                    <h3 style="margin:0; color:#ffc107;">ğŸ” ì¤‘ë³µ ì œê±° ê²°ê³¼ - ${date}</h3>
                    <div style="font-size:0.85em; color:#aaa; margin-top:5px;">Priority ê¸°ì¤€ ì •ë ¬ | ì¤‘ë³µ ê¸°ì‚¬ëŠ” í•˜ë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>
            `;

                    // ì¹´í…Œê³ ë¦¬ë³„ ë Œë”ë§
                    categoryResults.forEach(catGroup => {
                        const category = catGroup.category;
                        const catClass = catColors[category] || 'cat-default';
                        const catArticleIds = new Set(catGroup.article_ids || []);

                        // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê¸°ì‚¬ í•„í„° ë° Priority ì •ë ¬
                        const catArticles = dateArticles
                            .filter(a => {
                                // article_idë¥¼ JSONì—ì„œ ë³´ë‚¸ ê²ƒê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì¶”ì¶œ
                                const articleId = a.article_id || (() => {
                                    const parts = a.filename?.replace('.json', '').split('_') || [];
                                    return parts.length > 1 ? parts[parts.length - 1] : parts[0] || '';
                                })();
                                return catArticleIds.has(articleId);
                            })
                            .sort((a, b) => (b._priority || 0) - (a._priority || 0));

                        if (catArticles.length === 0) return;

                        // ì¹´í…Œê³ ë¦¬ í—¤ë”
                        html += `
                    <div class="category-group-header" style="background: linear-gradient(135deg, rgba(255,193,7,0.2), rgba(255,193,7,0.05));">
                        <div>
                            <span class="category-badge ${catClass}">${category}</span>
                            <span style="color:#ccc; font-size:0.9em;">${catArticles.length}ê°œ ê¸°ì‚¬</span>
                        </div>
                        <button class="btn" style="padding: 4px 8px; font-size: 0.8em; background: #4ecdc4; color: white;" 
                                onclick="selectCategory('${category}', '${date}')">â˜‘ï¸ ëª¨ë‘ ì„ íƒ</button>
                    </div>
                `;

                        // ê¸°ì‚¬ ì¹´ë“œë“¤
                        html += catArticles.map(article => renderArticleCard(article, date, catClass)).join('');
                    });

                    // ì¤‘ë³µ ê¸°ì‚¬ ì„¹ì…˜
                    const duplicateArticles = dateArticles
                        .filter(a => a._dedup_duplicate && !a.rejected && !a.published)
                        .sort((a, b) => (b._priority || 0) - (a._priority || 0));

                    if (duplicateArticles.length > 0) {
                        html += `
                    <div class="category-group-header" style="background: rgba(108,117,125,0.2); margin-top: 30px;">
                        <div>
                            <span class="category-badge cat-default">ğŸ—‘ï¸ ì¤‘ë³µ ì œê±°ë¨</span>
                            <span style="color:#888; font-size:0.9em;">${duplicateArticles.length}ê°œ ê¸°ì‚¬</span>
                        </div>
                    </div>
                `;

                        html += duplicateArticles.map(article => renderArticleCard(article, date, 'duplicate', true)).join('');
                    }

                    grid.innerHTML = html;
                    updateSelectedCount();
                }

                // ê°œë³„ ê¸°ì‚¬ ì¹´ë“œ ë Œë”ë§ (ì¬ì‚¬ìš© ê°€ëŠ¥)
                function renderArticleCard(article, date, extraClass = '', isDuplicate = false) {
                    const cardClass = isDuplicate ? 'duplicate' : (article.rejected ? 'rejected' : (article.published ? 'published' : ''));
                    const canSelect = !isDuplicate && !article.rejected && !article.published;
                    const checkboxHtml = canSelect
                        ? `<input type="checkbox" class="article-checkbox" data-filename="${article.filename}" data-date="${date}" checked onclick="toggleCheck(event)" onchange="updateSelectedCount()" style="width:18px; height:18px; cursor:pointer;">`
                        : '';

                    const priority = article._priority?.toFixed(2) || '-';
                    const is = article.impact_score?.toFixed(1) || '-';
                    const zs = article.zero_echo_score?.toFixed(1) || '-';

                    return `
                <div class="article-card ${cardClass} ${extraClass}" onclick="showDetail('${article.filename}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-size: 0.75em; color: #ffc107; font-weight:bold;">P:${priority}</span>
                            <span style="font-size: 0.75em; color: #666;">ğŸ“ ${article.article_id || '-'}</span>
                        </div>
                        ${checkboxHtml}
                    </div>
                    <div class="article-title">${article.title_ko || article.title || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="article-summary">${(article.summary || '').slice(0, 100)}...</div>
                    <div class="article-meta">
                        <span class="score-badge score-is">IS: ${is}</span>
                        <span class="score-badge score-zs">ZS: ${zs}</span>
                    </div>
                </div>
            `;
                }

                // ì¹´í…Œê³ ë¦¬ ê¸°ì‚¬ ì „ì²´ ì„ íƒ
                function selectCategory(category, date) {
                    // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì†í•œ ê¸°ì‚¬ë“¤ì˜ ì²´í¬ë°•ìŠ¤ ëª¨ë‘ ì„ íƒ
                    stagingData.forEach(article => {
                        if (article._dedup_category === category) {
                            const cb = document.querySelector(`.article-checkbox[data-filename="${article.filename}"]`);
                            if (cb) cb.checked = true;
                        }
                    });
                    updateSelectedCount();
                }

                document.addEventListener('DOMContentLoaded', loadStaging);
            </script>
</body>

</html>